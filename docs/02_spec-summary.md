# interactive-log-masking-cli ｜仕様まとめ

## 1. アプリ概要

ログファイル（またはログディレクトリ）に含まれる情報を、指定したルールに従ってマスキング（置換）し、 `out/` 配下へ出力する。

- 個人情報（メール/電話/ID 等）に限らず、**任意の文字列・トークン・識別子**を対象にできる
- CLI は **対話形式**で実行計画（入力・出力・ルール・dryRun など）を確定してから実行する

---

## 2. 想定実行環境

- OS: Windows / macOS / Linux
- Java: **21**
- ビルド/実行: Gradle（Gradle Wrapper）
- JSON: Jackson
- テスト: JUnit 5

---

## 3. スコープ（できること）

- 入力パス（ファイル or ディレクトリ）を受け取り、ディレクトリは**再帰的にファイルを列挙**して処理
- マスキングルールを以下から指定
  - JSON 設定ファイル（例: `rules/mask-rules.json`）
  - 対話でルールを作成（必要なら JSON として保存）
- 出力は `out/` 配下に **構造維持**して生成
- 出力ファイル名に **サフィックス付与**（例: `_masked`）が可能
- dryRun（件数集計のみ）に対応（ファイルは生成しない）
- 実行結果レポートを `out/` 配下に **report-\*.json** として出力（dryRun でも出力する）

---

## 4. 入出力仕様

### 4.1 入力（inputPath）

- 入力は **ファイル**または**ディレクトリ**を指定できる
- ディレクトリの場合は `Files.walk` 相当で再帰的に探索し、**通常ファイルのみ**を対象とする（フォルダ自体は加工しない）

### 4.2 出力（outRoot）

- 出力先は「出力先ディレクトリ（out 配下）」として指定する
- 出力は **常に outRoot 配下**に作られる（入力ファイル自体は変更しない）
- 出力先ディレクトリが存在しない場合は必要に応じて作成する

### 4.3 構造維持（ディレクトリ入力時）

入力がディレクトリの場合、`outRoot` 配下に **入力からの相対パス構造を維持**して出力する。

例:

- 入力: `input/sample/api/access-2026-01-05.log`
- 出力: `out/sample/api/access-2026-01-05_masked.log`（サフィックス付与時の例）

### 4.4 出力ファイル名サフィックス（任意）

- サフィックス付与を有効にした場合、**拡張子の直前**にサフィックスを挿入する
- 拡張子が無い場合は末尾に付与する
- ドットで始まるファイル（例: `.env`）も想定し、名前を崩さない形で付与する

例（サフィックス `_masked`）:

- `app.log` → `app_masked.log`
- `quick` → `quick_masked`
- `.env` → `.env_masked`

### 4.5 文字コード

- 読み込み: UTF-8
- 書き込み: UTF-8

---

## 5. ルール仕様（JSON）

### 5.1 JSON 全体構造

- `version` と `rules` を持つ

例:

```json
{
  "version": 1,
  "rules": [
    {
      "id": "email",
      "name": "メールアドレスをマスク",
      "enabled": true,
      "pattern": "[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}",
      "replacement": "[MASKED_EMAIL]",
      "flags": ["CASE_INSENSITIVE"]
    }
  ]
}
```

### 5.2 ルール（rules[]）のフィールド

- `id`（必須）: ルール識別子（**重複不可**）
- `name`（必須）: 表示用の名前
- `enabled`（任意）: 有効/無効（省略時は **true 扱い**）
- `pattern`（必須）: Java の正規表現
- `replacement`（必須）: 置換文字列（null 不可）
- `flags`（任意）: 正規表現フラグ配列
  - 現状の対応フラグ: `CASE_INSENSITIVE`

### 5.3 バリデーション（読み込み時に検証）

読み込み時にルールを検証し、NG の場合は例外として扱う（処理は開始しない）。

- `version` は 1 を要求
- `rules` が空でないこと
- 各ルールの必須項目（`id`, `name`, `pattern`）が空でないこと
- `id` の重複がないこと
- `pattern` が使用可能であること（壊れた正規表現は NG）
- 未対応の `flags` は NG

---

## 6. 実行フロー

対話形式で以下を順に確定する。

- 入力パス（ファイル or ディレクトリ）
- 出力先ディレクトリ（out 配下）
- dryRun（件数集計のみ、ファイルは生成しない）にするか
- 出力ファイル名にサフィックスを付与するか
- サフィックス文字列（例: `_masked`）
- ルール指定方法
  - JSON 設定ファイルを使う（ルール JSON のパスを指定）
  - 対話でルールを作成する（必要なら保存）

最後に「実行内容（RunPlan 相当）」を表示し、確認後に実行する。

---

## 7. マスキング処理仕様（コア）

- ルールは **配列順に上から順**で適用する
- 各ルールは「正規表現に一致した箇所を replacement に置換」する
- 置換件数はルールごとにカウントする
- dryRun の場合
  - 置換件数は通常実行と同様に算出する
  - **出力ファイルは生成しない**（書き込みを行わない）

---

## 8. レポート仕様（out/report-\*.json）

### 8.1 出力先・ファイル名

- `out/` 配下に毎回新規で出力する
- 形式: `report-YYYYMMDD-HHMMSS-SSS.json`
- 同名衝突の可能性がある場合は、連番のような形で回避して一意な名前にする

### 8.2 レポートに含める内容

ログ本文そのものや「置換前後のサンプル」は含めず、件数やパス中心で出力する。

- schemaVersion
- generatedAt（生成日時）
- durationMs（実行時間）
- dryRun（true/false）
- inputRoot / outRoot
- rulesSource（ルール指定元。例: ルール JSON のパス）
- suffix（有効な場合）
- totalFiles（対象ファイル数）
- totalCount（合計置換件数）
- totalCountsPerRule（ルール別合計件数）
- rulesMeta（id → name）
- fileReports（ファイル別）
  - inputFile（入力ファイル）
  - outputFile（出力先ファイル。dryRun でも「出力予定パス」として記録）
  - totalCount（ファイル単位の合計件数）
  - countsPerRule（ルール別件数）

---

## 9. エラー時の扱い

- ルール検証エラーやファイル I/O エラーなどは例外として扱い、処理は中断される

---

## 10. 運用・安全上の注意

- 入力ログは**コピーを使う**ことを推奨（入力は改変しないが、運用上の安全のため）
